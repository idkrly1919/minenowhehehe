<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>cherri | mini browser</title>
    <link rel="shortcut icon" href="/assets/img/fav.png" type="image/x-icon" id="tabIcon">
    <link rel="stylesheet" href="/assets/css/colors.css" id="css-theme-link">
    <link rel="stylesheet" href="/assets/css/elements.css">
    <link rel="stylesheet" href="/assets/css/font.css">
    <link rel="stylesheet" href="/assets/icons/fonts/remixicon.css">
    <script src="/assets/js/lib/particles.js"></script>
    <script src="/baremux/index.js"></script>
    <script src="/assets/js/colors.js"></script>
    <script src="/sj/scramjet.all.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/eruda@3.4.3/eruda.min.js"></script>
    <script>
        async function swium() {
            await navigator.serviceWorker.register("/sw.js").then(() => {
                console.log(
                    "%ccherri" + "%c SJ sw registered!",
                    "color: white; background: linear-gradient(to bottom right, #e2588d, #dbd7d7); border-radius: 5px; font-weight: bold; padding: 6px; font-family: monospace;",
                    "color: white; background: transparent; border-radius: 0px; padding: 0px;"
                );
            }).catch(e => {
                console.log("Error registering service worker (SJ): " + e)
            });
        }

        window.addEventListener("load", () => {
            swium();
        });
    </script>
</head>

<body>

    <style>
        .browser-container {
            background: var(--bg);
            width: 100%;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 6;
            transition: 0.2s;
        }

        .browser-frame {
            width: 100%;
            height: 100vh;
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 0px;
            border: 0px solid var(--border-3);
            display: none;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
        }

        .browser-frame.active {
            display: block;
            opacity: 1;
            pointer-events: all;
        }

        .browser-controls {
            position: fixed;
            width: 100%;
            left: 0;
            top: 0;
            padding: 15px;
        }

        .tabs {
            display: none;
            align-items: center;
            gap: 5px;
            margin-left: 0px;
            margin-bottom: 10px;
        }

        .browser-buttons {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .browser-buttons .hcontainer {
            display: flex;
            position: absolute;
            left: 50%;
            transform: translateX(-51%);
            margin-top: 35px;
            gap: 05px;
            width: 95%;
        }

        .browser-buttons button {
            height: 40px;
            width: 40px;
            flex-shrink: 0;
            padding: 0;
            font-size: 16px;
            border-radius: 10px;
            transition: 0.2s;
            cursor: pointer;
            background: var(--bg-2);
            border: 1px solid var(--border-4);
            color: var(--bright-text);
        }

        .browser-buttons button:hover {
            background: var(--bg-3);
            color: var(--bright-text);
        }

        .ri {
            font-size: 20px;
        }

        .browser-buttons input {
            background: var(--bg-3);
            border: 1px solid var(--border-4);
            border-radius: 10px;
            height: 40px;
            padding: 0 20px;
            flex: 0.95;
            transition: 0.2s;
            color: var(--bright-text);
            font-family: Arial;
            outline: none;
            font-size: 14px;
        }

        .browser-buttons input:focus {
            outline: none;
            border: 1px solid var(--accent);
        }

        .browser-buttons input::placeholder {
            color: var(--text);
        }

        .tab {
            background: var(--bg-2);
            max-width: 200px;
            min-width: 25px;
            padding: 10px 15px;
            border-radius: 10px;
            transition: 0.2s;
            border: 1px solid var(--border-4);
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .tab span {
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            flex: 1;
            color: var(--text);
        }

        .tab:hover {
            background: var(--bg-3);
        }

        .tab.active {
            background: var(--bg-3);
            border: 1px solid var(--border-3);
        }

        .tab img {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .tab .close-btn {
            font-size: 20px;
            cursor: pointer;
            transition: 0.2s;
            color: var(--bright-text);
            flex-shrink: 0;
        }

        .tab .close-btn:hover {
            color: var(--accent);
        }

        .newtab {
            background: var(--bg-2);
            height: 40px;
            width: 40px;
            border-radius: 10px;
            transition: 0.2s;
            cursor: pointer;
            border: 1px solid var(--border-4);
            color: var(--bright-text);
            flex-shrink: 0;
        }

        .newtab:hover {
            background: var(--bg-3);
            color: var(--bright-text);
        }

        .browser-loading {
            background: var(--bg-2);
            height: 3px;
            width: 200px;
            position: relative;
            transform: translate(-50%, -50%);
            left: 50%;
            top: 50%;
            border-radius: 100px;
        }

        .browser-loading::after {
            content: "";
            position: absolute;
            height: 100%;
            background: var(--accent);
            left: 0;
            border-radius: 100px;
            bottom: 0;
            width: 100%;
            animation: browser-loading-lol .75s infinite ease;
        }

        @keyframes browser-loading-lol {
            0% {
                transform-origin: left;
                transform: scaleX(0);
            }

            50% {
                transform-origin: left;
                transform: scaleX(1);
            }

            50.01% {
                transform-origin: right;
                transform: scaleX(1);
            }

            100% {
                transform-origin: right;
                transform: scaleX(0);
            }
        }
    </style>

    <div class="browser-container">
        <div class="browser-loading"></div>
    </div>
    <script defer>
        let aTab = 0;
            let tabCounter = 1;
            let bTabs = [];
            const connection = new BareMux.BareMuxConnection("/baremux/worker.js");
            const wispUrl = localStorage.getItem("cherri_wispUrl") || "wss://wisp.rhw.one/";
            const bareUrl = "https://useclassplay.vercel.app/fq/";

            let searchE;
            const se = localStorage.getItem("cherri_searchEngine") || "DuckDuckGo";

            if (se === "DuckDuckGo") {
                searchE = "https://duckduckgo.com/search?q=";
            } else if (se === "Bing") {
                searchE = "https://bing.com/search?q=";
            } else if (se === "Google") {
                searchE = "https://google.com/search?q=";
            } else if (se === "Startpage") {
                searchE = "https://startpage.com/search?q=";
            } else if (se === "Qwant") {
                searchE = "https://qwant.com/search?q=";
            } else {
                searchE = "https://search.brave.com/search?q=";
            }

            connection.setTransport("/libcurl/index.mjs", [{ websocket: wispUrl }]);

            const CONFIG = {
                files: {
                    wasm: "/sj/scramjet.wasm.wasm",
                    all: "/sj/scramjet.all.js",
                    sync: "/sj/scramjet.sync.js",
                },
            };

            const { ScramjetController } = $scramjetLoadController();
            const scramjet = new ScramjetController({
                files: CONFIG.files,
            });
            scramjet.init();

            function nav(i) {
                console.log("e");
                if (!i.trim()) return;

                let url = i.trim();

                if (!url.includes(".") || url.includes(" ")) {
                    url = searchE + encodeURIComponent(url);
                } else {
                    if (!url.startsWith("http://") && !url.startsWith("https://")) {
                        url = "https://" + url;
                    }
                }

                const cTab = bTabs.find((t) => t.id === aTab);
                if (!cTab) return;

                cTab.history.push(url);
                cTab.historyIndex++;

                cTab.url = url;

                if (
                    localStorage.getItem("cherri_backend") === "Scramjet" ||
                    localStorage.getItem("cherri_backend") === "scramjet" ||
                    !localStorage.getItem("cherri_backend")
                ) {
                    fUrl = scramjet.encodeUrl(url);
                } else if (localStorage.getItem("cherri_backend") === "Ultraviolet") {
                    fUrl = "/uv/service/" + __uv$config.encodeUrl(url);
                } else {
                    fUrl = scramjet.encodeUrl(url);
                }

                go(fUrl);
            }

            function updateUrlFromIframe(viewframe) {
                try {
                    const cTab = bTabs.find((t) => t.id === aTab);
                    if (!cTab) return;

                    let decodedUrl;
                    const currentSrc = viewframe.src;

                    if (localStorage.getItem("cherri_backend") === "Ultraviolet") {
                        if (currentSrc.includes("/uv/service/")) {
                            decodedUrl = __uv$config.decodeUrl(currentSrc.split("/uv/service/")[1]);
                        }
                    } else {
                        decodedUrl = scramjet.decodeUrl(currentSrc);
                    }

                    if (decodedUrl && decodedUrl !== cTab.url) {
                        cTab.url = decodedUrl;

                        const ubar = document.getElementById("searchbar");
                        if (ubar) ubar.value = decodedUrl;

                        const favEl = document.querySelector(`#fav[data-fav-id="${aTab}"]`);
                        if (favEl)
                            favEl.src = `https://www.google.com/s2/favicons?domain=${decodedUrl}&sz=256`;
                    }
                } catch (e) {
                    console.error("Error updating URL from iframe:", e);
                }
            }

            async function go(u) {
                if (!(await connection.getTransport())) {
                    connection.setTransport("/libcurl/index.mjs", [{ websocket: wispUrl }]);
                }

                console.log("a");
                const cTab = bTabs.find((t) => t.id === aTab);
                const favEl = document.querySelector(`#fav[data-fav-id="${aTab}"]`);
                const viewframe = document.querySelector(
                    `.viewframe[data-frame-id="${aTab}"]`
                );
                if (!viewframe) return;

                const ubar = document.getElementById("searchbar");

                const tabEl = document.querySelector(`.tab[data-tab-id="${aTab}"]`);
                if (tabEl) {
                    const titleEl = tabEl.querySelector("span");
                    if (titleEl) titleEl.textContent = "Loading...";
                }

                if (ubar) ubar.value = cTab.url;
                const favUrl = cTab.url;
                if (favEl)
                    favEl.src = `https://www.google.com/s2/favicons?domain=${favUrl}&sz=256`;

                try {
                    viewframe.src = u;
                    console.log("ooooo");

                    viewframe.onload = () => {
                        try {
                            const iframeDoc =
                                viewframe.contentDocument || viewframe.contentWindow.document;
                            const title = iframeDoc.title || new URL(cTab.url).hostname;

                            const tabEl = document.querySelector(`.tab[data-tab-id="${aTab}"]`);
                            if (tabEl) {
                                const titleEl = tabEl.querySelector("span");
                                if (titleEl) titleEl.textContent = title;
                            }

                            updateUrlFromIframe(viewframe);
                        } catch (e) {
                            console.error("Error accessing iframe content:", e);
                            const tabEl = document.querySelector(`.tab[data-tab-id="${aTab}"]`);
                            if (tabEl) {
                                const titleEl = tabEl.querySelector("span");
                                if (titleEl) titleEl.textContent = new URL(cTab.url).hostname;
                            }

                            updateUrlFromIframe(viewframe);
                        }
                    };
                } catch (e) {
                    console.error("There was an error while loading the page:", e);
                    showToast(
                        "error",
                        "There was a problem loading the page. Check the console for more info.",
                        "fas fa-times-circle"
                    );
                }
            }

            function b() {
                const cTab = bTabs.find((t) => t.id === aTab);
                if (!cTab || cTab.historyIndex <= 0) return;

                cTab.historyIndex--;
                const u = cTab.history[cTab.historyIndex];
                cTab.url = u;
                let furl;
                const ba = localStorage.getItem("cherri_backend");
                if (ba.toLowerCase() === "scramjet") {
                    furl = scramjet.encodeUrl(u);
                } else if (ba.toLowerCase() === "ultraviolet") {
                    furl = __uv$config.prefix + __uv$config.encodeUrl(u);
                } else {
                    furl = scramjet.encodeUrl(u);
                }

                go(furl);
            }

            function f() {
                const cTab = bTabs.find((t) => t.id === aTab);

                cTab.historyIndex++;
                const u = cTab.history[cTab.historyIndex];
                cTab.url = u;
                let furl;
                const ba = localStorage.getItem("cherri_backend");
                if (ba.toLowerCase() === "scramjet") {
                    furl = scramjet.encodeUrl(u);
                } else if (ba.toLowerCase() === "ultraviolet") {
                    furl = __uv$config.prefix + __uv$config.encodeUrl(u);
                } else {
                    furl = scramjet.encodeUrl(u);
                }

                go(furl);
            }

            function r() {
                const viewframe = document.querySelector(
                    `.viewframe[data-frame-id="${aTab}"]`
                );
                const curl = viewframe.src;

                viewframe.src = curl;
            }

            function full() {
                const viewframe = document.querySelector(
                    `.viewframe[data-frame-id="${aTab}"]`
                );
                viewframe.requestFullscreen();
                console.log("sdfkjhasdkjhfg");
            }

            function hideBrowser() {
                const b = document.querySelector(".browser-container");
                const frames = document.querySelectorAll(".viewframe");
                b.style.opacity = 0;
                frames.forEach((frame) => {
                    frame.style.opacity = 0;
                    frame.style.pointerEvents = "none";
                });
                b.style.pointerEvents = "none";
            }

            async function launchEruda() {
                showToast("info", "Launching Eruda...", "fas fa-info-circle");
                try {
                    eruda.init();
                    showToast(
                        "success",
                        "Successfully injected Eruda",
                        "fa-solid fa-check-circle"
                    );
                } catch (e) {
                    showToast("error", "Failed to inject Eruda", "fas fa-times-circle");
                }
            }
    </script>
</body>

</html>